name: ArgoCD FIPS-Compliant Build

on:
  workflow_call:
  workflow_dispatch:
  push:
    paths:
      - 'projects/argocd/**'
      - 'patches/argocd/**'
      - '.mailknight.yml'
      - 'scripts/**'

env:
  PROJECT_NAME: "argocd"
  UPSTREAM_REPO: "https://github.com/argoproj/argo-cd.git"
  UPSTREAM_VERSION: "v2.11.0"
  GO_VERSION: "1.21"
  NODE_VERSION: "18"
  
  # ArgoCD specific build variables
  ARGOCD_VERSION: "v2.11.0-mailknight"
  GOOS: "linux"
  GOARCH: "amd64"
  CGO_ENABLED: "1"
  
  # Security and build hardening
  CFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -fPIE -O2"
  CXXFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -fPIE -O2"
  LDFLAGS: "-Wl,-z,relro,-z,now -pie"
  CGO_CFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2"
  CGO_LDFLAGS: "-Wl,-z,relro,-z,now"
  
  # FIPS compliance
  OPENSSL_FORCE_FIPS_MODE: "1"
  GOLANG_FIPS: "1"
  
  # Build reproducibility
  SOURCE_DATE_EPOCH: "1672531200"  # 2023-01-01

jobs:
  # Fetch ArgoCD source code (shared for all containers)
  fetch-source:
    runs-on: ubuntu-latest
    container:
      image: registry.access.redhat.com/ubi8/ubi-minimal:latest
      
    steps:
    - name: Checkout mailknight
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        microdnf update -y
        microdnf install -y git wget curl ca-certificates findutils tar
        echo "FIPS Mode Check:"
        if [ -f /proc/sys/crypto/fips_enabled ]; then cat /proc/sys/crypto/fips_enabled; fi
        
    - name: Fetch upstream source
      run: |
        chmod +x scripts/fetch-upstream.sh
        scripts/fetch-upstream.sh ${PROJECT_NAME} ${UPSTREAM_VERSION}
        
    - name: Upload source artifacts
      uses: actions/upload-artifact@v4
      with:
        name: argocd-source
        path: source/
        retention-days: 1

  # Apply Mailknight patches for FIPS compliance
  apply-patches:
    runs-on: ubuntu-latest
    needs: fetch-source
    container:
      image: registry.access.redhat.com/ubi8/ubi-minimal:latest
      
    steps:
    - name: Checkout mailknight
      uses: actions/checkout@v4
      
    - name: Download source artifacts
      uses: actions/download-artifact@v4
      with:
        name: argocd-source
        path: source/
        
    - name: Setup environment
      run: |
        microdnf update -y
        microdnf install -y git wget curl ca-certificates findutils tar
        
    - name: Apply patches
      run: |
        chmod +x scripts/apply-patches.sh
        scripts/apply-patches.sh ${PROJECT_NAME} ${UPSTREAM_VERSION}
        
    - name: Upload patched source
      uses: actions/upload-artifact@v4
      with:
        name: argocd-patched-source
        path: source/
        retention-days: 1

  # Build ArgoCD binaries with FIPS compliance
  build-binary:
    runs-on: ubuntu-latest
    needs: apply-patches
    container:
      image: registry.access.redhat.com/ubi8/ubi-minimal:latest
      
    steps:
    - name: Checkout mailknight
      uses: actions/checkout@v4
      
    - name: Download patched source
      uses: actions/download-artifact@v4
      with:
        name: argocd-patched-source
        path: source/
        
    - name: Setup build environment
      run: |
        microdnf update -y
        microdnf install -y git wget curl ca-certificates gcc gcc-c++ make nodejs npm tar
        curl -L "https://golang.org/dl/go${GO_VERSION}.linux-amd64.tar.gz" | tar -xz -C /usr/local
        export PATH="/usr/local/go/bin:$PATH"
        go version
        node --version
        
    - name: Install Syft for SBOM generation
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin v${SYFT_VERSION}
        syft version
        
    - name: Build project
      run: |
        export PATH="/usr/local/go/bin:$PATH"
        chmod +x scripts/build-project.sh
        scripts/build-project.sh ${PROJECT_NAME}
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: argocd-binaries
        path: |
          build/
          sbom.json
        retention-days: 1

  # Build container images matrix for all ArgoCD components
  build-containers:
    runs-on: ubuntu-latest
    needs: build-binary
    strategy:
      matrix:
        container:
          - name: server
            dockerfile: Dockerfile.server
          - name: repo-server
            dockerfile: Dockerfile.repo-server
          - name: application-controller
            dockerfile: Dockerfile.controller
          - name: applicationset-controller
            dockerfile: Dockerfile.applicationset-controller
          - name: dex
            dockerfile: Dockerfile.dex
          - name: notification
            dockerfile: Dockerfile.notification
    
    steps:
    - name: Checkout mailknight
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: argocd-binaries
        path: .
        
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build container
      run: |
        chmod +x scripts/build-container.sh
        scripts/build-container.sh ${PROJECT_NAME} ${UPSTREAM_VERSION} ${{ matrix.container.name }} ${{ matrix.container.dockerfile }}
        
    - name: Upload container artifacts
      uses: actions/upload-artifact@v4
      with:
        name: argocd-container-${{ matrix.container.name }}
        path: |
          images/${{ matrix.container.name }}/
          image-sbom-${{ matrix.container.name }}.json
        retention-days: 1

  # Scan containers for vulnerabilities
  scan-vulnerabilities:
    runs-on: ubuntu-latest
    needs: build-containers
    strategy:
      matrix:
        container: [server, repo-server, application-controller, applicationset-controller, dex, notification]
    container:
      image: registry.access.redhat.com/ubi8/ubi-minimal:latest
      
    steps:
    - name: Checkout mailknight
      uses: actions/checkout@v4
      
    - name: Download container artifacts
      uses: actions/download-artifact@v4
      with:
        name: argocd-container-${{ matrix.container }}
        path: .
        
    - name: Setup environment
      run: |
        microdnf update -y
        microdnf install -y git wget curl ca-certificates tar
        
    - name: Install Trivy
      run: |
        # Install without sudo since we're in a container
        TRIVY_URL="https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz"
        curl -sL "$TRIVY_URL" | tar -xz -C /tmp
        mv /tmp/trivy /usr/local/bin/trivy
        chmod +x /usr/local/bin/trivy
        trivy --version
        
    - name: Scan image
      run: |
        chmod +x scripts/scan-image.sh
        scripts/scan-image.sh ${PROJECT_NAME} ${UPSTREAM_VERSION} ${{ matrix.container }}
        
    - name: Upload scan results
      uses: actions/upload-artifact@v4
      with:
        name: argocd-scan-results-${{ matrix.container }}
        path: scan-results/${{ matrix.container }}/
        retention-days: 7
        
    - name: Upload security reports
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: scan-results/${{ matrix.container }}/trivy-container.sarif
        category: container-${{ matrix.container }}
      continue-on-error: true

  # Test FIPS compliance for containers
  test-fips-compliance:
    runs-on: ubuntu-latest
    needs: build-containers
    strategy:
      matrix:
        container: [server, repo-server, application-controller, applicationset-controller, dex, notification]
    container:
      image: registry.access.redhat.com/ubi8/ubi-minimal:latest
      
    steps:
    - name: Checkout mailknight
      uses: actions/checkout@v4
      
    - name: Download container artifacts
      uses: actions/download-artifact@v4
      with:
        name: argocd-container-${{ matrix.container }}
        path: .
        
    - name: Setup environment
      run: |
        microdnf update -y
        microdnf install -y git wget curl ca-certificates tar
        
    - name: Test FIPS compliance
      run: |
        chmod +x scripts/test-fips-compliance.sh
        scripts/test-fips-compliance.sh ${PROJECT_NAME} ${UPSTREAM_VERSION} ${{ matrix.container }}
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: argocd-fips-test-${{ matrix.container }}
        path: test-results/${{ matrix.container }}/
        retention-days: 7

  # Release artifacts (only on tags or manual dispatch)
  release-artifacts:
    runs-on: ubuntu-latest
    needs: [scan-vulnerabilities, test-fips-compliance]
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    container:
      image: registry.access.redhat.com/ubi8/ubi-minimal:latest
      
    steps:
    - name: Checkout mailknight
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Setup environment
      run: |
        microdnf update -y
        microdnf install -y git wget curl ca-certificates tar
        
    - name: Release artifacts
      run: |
        chmod +x scripts/release-artifacts.sh
        scripts/release-artifacts.sh ${PROJECT_NAME} ${UPSTREAM_VERSION}
        
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: argocd-release
        path: releases/
        retention-days: 30